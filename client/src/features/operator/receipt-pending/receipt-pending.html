<div class="min-h-screen bg-base-100 text-base-content flex flex-col items-center py-10 px-4 mt-10">
  <div class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-8 transition-all duration-300">
    <h2 class="text-3xl font-bold mb-6 flex items-center gap-2 text-base-content">
      Danh s√°ch h√≥a ƒë∆°n ch·ªù x√°c nh·∫≠n
    </h2>

    <div *ngIf="loading" class="text-center py-10 text-secondary text-lg flex justify-center items-center gap-3">
      <span class="loading loading-spinner loading-lg"></span>
      ƒêang t·∫£i d·ªØ li·ªáu...
    </div>

    <div *ngIf="!loading && receipts.length > 0" class="overflow-x-auto rounded-xl border border-base-300 shadow-sm">
      <table class="table table-zebra w-full text-center">
        <thead class="bg-base-200 text-base font-semibold">
          <tr>
            <th>ID</th>
            <th>Kh√°ch h√†ng</th>
            <th>G√≥i c∆∞·ªõc</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>Ng√†y t·∫°o</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let r of receipts"
            class="hover:bg-primary/10 transition-all duration-200 ease-in-out cursor-pointer"
            (click)="viewDetails(r.id)"
          >
            <td class="font-semibold">#{{ r.id }}</td>
            <td>{{ r.appUserName || '‚Äî' }}</td>
            <td>{{ r.pricingName }}</td>
            <td class="text-success font-semibold">{{ r.totalCost | number }} ‚Ç´</td>
            <td>{{ r.createAt | date : 'short' }}</td>
            <td>
              <button
                class="btn btn-sm btn-primary hover:scale-105 transition-transform"
                (click)="viewDetails(r.id); $event.stopPropagation()"
              >
                Xem chi ti·∫øt
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="!loading && receipts.length === 0" class="text-center py-10 text-gray-500 text-lg">
      üö´ Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o ƒëang ch·ªù x√°c nh·∫≠n.
    </div>
  </div>
</div>

<div
  *ngIf="showDetails"
  (click)="closeDetails()"
  class="fixed inset-0 bg-black bg-opacity-40 z-40 transition-opacity duration-300 ease-in-out"
></div>

<div
  class="fixed top-0 right-0 h-full w-full max-w-lg bg-base-100 shadow-2xl z-50 transform transition-transform duration-300 ease-in-out flex flex-col"
  [ngClass]="{ 'translate-x-0': showDetails, 'translate-x-full': !showDetails }"
>
  <ng-container *ngIf="selectedReceipt">
    
    <div class="p-6 bg-white border-b border-base-200 flex flex-col gap-2 relative">
      <button
        (click)="closeDetails()"
        class="absolute top-4 right-4 btn btn-sm btn-circle btn-ghost hover:bg-base-200"
      >
        ‚úï
      </button>
      <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-500">H√≥a ƒë∆°n</h3>
      <div class="flex items-baseline justify-between">
        <span class="text-2xl font-bold text-gray-800">#{{ selectedReceipt.id }}</span>
        <span
          class="badge text-sm px-3 py-2"
          [ngClass]="{
            'badge-warning': selectedReceipt.status === 'Pending',
            'badge-success': selectedReceipt.status === 'Paid',
            'badge-error': selectedReceipt.status === 'Cancelled'
          }"
        >
          {{ selectedReceipt.status }}
        </span>
      </div>
      <div class="text-3xl font-extrabold text-primary mt-3">
        {{ selectedReceipt.totalCost | number }} ‚Ç´
      </div>
    </div>

    <div class="flex-grow overflow-y-auto p-6 space-y-6 bg-base-50 text-sm">
      
      <section class="bg-white rounded-lg p-5 shadow-sm border border-base-200">
        <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fa-regular fa-user text-primary text-lg"></i> Th√¥ng tin kh√°ch h√†ng
        </h4>
        <div class="space-y-3 text-gray-700">
          <div class="flex justify-between items-center">
            <span class="text-gray-500">T√™n kh√°ch h√†ng:</span>
            <span class="font-medium text-gray-800">{{ selectedReceipt.appUserName || 'N/A' }}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">ID kh√°ch h√†ng:</span>
            <span class="font-medium text-gray-800">{{ selectedReceipt.appUserId || 'N/A' }}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">G√≥i c∆∞·ªõc:</span>
            <span class="font-medium text-gray-800">{{ selectedReceipt.pricingName || 'N/A' }}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">T√™n g√≥i d·ªãch v·ª•:</span>
            <span class="font-medium text-gray-800">{{ selectedReceipt.packageName || 'N/A' }}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">Ng√†y t·∫°o h√≥a ƒë∆°n:</span>
            <span class="font-medium text-gray-800">{{ selectedReceipt.createAt | date : 'medium' }}</span>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg p-5 shadow-sm border border-base-200">
        <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fa-solid fa-list-ol text-primary text-lg"></i> C√°c phi√™n s·∫°c
        </h4>
        
        <div *ngIf="selectedReceipt.chargingSessions && selectedReceipt.chargingSessions.length > 0; else noSessions" class="space-y-4">
          <div *ngFor="let session of selectedReceipt.chargingSessions" class="pb-3 border-b border-base-200 last:pb-0 last:border-b-0">
            <div class="flex justify-between items-center mb-1">
              <span class="font-semibold text-gray-800">Tr·ª•: {{ session.chargingPostCode }}</span>
              <span class="font-bold text-primary">{{ session.energyUsed | number: '1.2-2' }} kWh</span>
            </div>
            <div class="text-xs text-gray-500 flex items-center gap-2">
              <i class="fa-regular fa-clock"></i>
              <span>
                {{ session.startTime | date: 'shortTime' }} - {{ session.endTime | date: 'shortTime' }}
                <span class="italic">({{ session.startTime | date: 'dd/MM' }})</span>
              </span>
            </div>
          </div>
        </div>
        
        <ng-template #noSessions>
          <p class="text-gray-500 text-xs italic">Kh√¥ng c√≥ d·ªØ li·ªáu phi√™n s·∫°c cho h√≥a ƒë∆°n n√†y.</p>
        </ng-template>
      </section>

      <section class="bg-white rounded-lg p-5 shadow-sm border border-base-200">
        <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fa-solid fa-bolt text-primary text-lg"></i> Chi ti·∫øt c√°c kho·∫£n ph√≠
        </h4>
        <div class="space-y-3 text-gray-700">
          <div class="flex justify-between items-center">
            <span class="text-gray-500">NƒÉng l∆∞·ª£ng ti√™u th·ª• (t·ªïng):</span>
            <span class="font-medium text-gray-800">{{ selectedReceipt.energyConsumed | number : '1.2-2' }} kWh</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">ƒê∆°n gi√° ƒëi·ªán (th·ªùi ƒëi·ªÉm s·∫°c):</span>
            <span class="font-medium text-gray-800">{{ selectedReceipt.pricePerKwhSnapshot | number }} ‚Ç´/kWh</span>
          </div>
          <div class="my-3 border-b border-dashed border-base-300"></div> 
          <div class="flex justify-between items-center font-semibold text-gray-800 text-base">
            <span>Ti·ªÅn ƒëi·ªán:</span>
            <span>+ {{ selectedReceipt.energyCost | number }} ‚Ç´</span>
          </div>

          <ng-container *ngIf="selectedReceipt.idleFee > 0">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Ph√≠ ch·ªù (Idle):</span>
              <span class="font-medium text-gray-800">+ {{ selectedReceipt.idleFee | number }} ‚Ç´</span>
            </div>
            <p class="text-xs text-gray-500 pl-4">
              (Th·ªùi gian ch·ªù: {{ selectedReceipt.idleStartTime | date: 'HH:mm' }} - {{ selectedReceipt.idleEndTime | date: 'HH:mm' }})
            </p>
          </ng-container>
          
          <div *ngIf="selectedReceipt.overstayFee > 0" class="flex justify-between items-center">
            <span class="text-gray-500">Ph√≠ qu√° gi·ªù (Overstay):</span>
            <span class="font-medium text-gray-800">+ {{ selectedReceipt.overstayFee | number }} ‚Ç´</span>
          </div>
          
          <div *ngIf="selectedReceipt.discountAmount > 0" class="flex justify-between items-center text-warning font-semibold">
            <span>Gi·∫£m gi√°:</span>
            <span>- {{ selectedReceipt.discountAmount | number }} ‚Ç´</span>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg p-5 shadow-sm border border-base-200">
        <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fa-regular fa-credit-card text-primary text-lg"></i> Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
        </h4>
        <div class="mb-4">
          <select
            id="paymentMethod"
            [(ngModel)]="paymentMethod"
            class="select select-bordered w-full max-w-xs focus:ring-primary focus:border-primary text-sm"
          >
            <option *ngFor="let method of paymentMethods" [value]="method">
              {{ method }}
            </option>
          </select>
        </div>

      </section>
    </div>

    <div class="sticky bottom-0 p-5 border-t border-base-200 bg-white flex justify-end gap-3 shadow-t-lg">
      <button
        class="btn btn-ghost hover:bg-base-200"
        (click)="closeDetails()"
        [disabled]="confirming"
      >
        ƒê√≥ng
      </button>
      <button
        class="btn btn-primary shadow-md hover:shadow-lg transition-all"
        (click)="confirmPayment()"
        [disabled]="confirming" 
      >
        <ng-container *ngIf="!confirming">X√°c nh·∫≠n thanh to√°n</ng-container>
        <ng-container *ngIf="confirming">
          <span class="loading loading-spinner"></span> ƒêang x·ª≠ l√Ω...
        </ng-container>
      </button>
    </div>
  </ng-container>
</div>